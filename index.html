<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng Dụng Tạo Đề Thi Trắc Nghiệm từ Excel/CSV (Hỗ Trợ 10 Đáp Án)</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải thư viện xử lý Excel (SheetJS) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- Cấu hình Font và Style -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            /* Thêm các font hệ thống phổ biến có hỗ trợ tiếng Việt làm font dự phòng */
            font-family: 'Inter', 'Arial', 'Tahoma', 'Verdana', sans-serif;
            background-color: #f3f4f6;
        }
        /* Style cho đáp án đúng khi hiển thị */
        .correct-choice {
            background-color: #d1fae5 !important; /* green-100 */
            border-color: #10b981 !important; /* green-500 */
            font-weight: 600;
        }
        /* Style cho nút đã được sử dụng */
        .choice-btn.selected {
            /* Tông màu xanh khi người dùng chọn */
            background-color: #bfdbfe; /* blue-200 */
            border-color: #3b82f6; /* blue-500 */
            font-weight: 500;
        }
        /* Style cho phần tử thông báo (message box) */
        #message-box {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            max-width: 90%;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(-20px);
            opacity: 0;
        }
        #message-box.show {
            transform: translateY(0);
            opacity: 1;
        }
        /* Class mới cho chế độ hiển thị đáp án ngay lập tức */
        .quiz-revealed .choice-btn {
            pointer-events: none; /* Vô hiệu hóa tất cả các lựa chọn khi ở chế độ Revealed */
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Message Box -->
    <div id="message-box" role="alert"></div>

    <div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-2">Ứng Dụng Tạo Đề Thi Trắc Nghiệm</h1>
            <p class="text-gray-600">Hỗ trợ tải đề thi từ file Excel/CSV. Đã tối ưu hiệu suất cho dữ liệu lớn.</p>
        </header>

        <!-- Main Content Area -->
        <main id="main-content">
            <!-- Content will be rendered here based on the view state (UPLOAD, QUIZ, RESULT) -->
        </main>
    </div>

    <script>
        // --- CONSTANTS CHO LOCALSTORAGE ---
        const QUIZ_DATA_STORAGE_KEY = 'quiz_app_quiz_data';

        // --- GLOBAL STATE ---
        // Trạng thái chung của ứng dụng
        let quizData = []; // Dữ liệu câu hỏi gốc từ file
        let userAnswers = {}; // { index: [selectedChoiceIndex, ...] } - Hỗ trợ Multi-Choice
        let revealedAnswers = {}; // { index: true } - Cờ để hiển thị đáp án đúng sau khi nộp bài
        let isPracticeMode = false; // TRẠNG THÁI: Hiển thị đáp án đúng ngay lập tức (Chế độ Ôn tập)
        
        // Trạng thái cho tối ưu hiệu suất (Pagination & Filtering)
        let currentPage = 1;
        const questionsPerPage = 50; // Số câu hỏi hiển thị mỗi trang
        let filteredQuizData = []; // Dữ liệu đã được lọc/tìm kiếm
        
        // --- DOM REFERENCES ---
        const mainContent = document.getElementById('main-content');
        const messageBox = document.getElementById('message-box');
        
        // Cần các biến này ở phạm vi toàn cục để gắn sự kiện
        let fileInput;
        let submitButton;
        let restartButton;
        let searchInput;
        let quizContainer;
        let paginationContainer;
        let practiceModeButton;

        // --- ENUMS & CONSTANTS ---
        const STATE = {
            UPLOAD: 'upload',
            QUIZ: 'quiz',
            RESULT: 'result'
        };

        // --- UTILITY FUNCTIONS ---
        
        /**
         * Chức năng Debounce (Giảm tần suất gọi hàm)
         * Quan trọng để tối ưu ô tìm kiếm trên dữ liệu lớn
         */
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        /**
         * Hiển thị thông báo ở góc trên bên phải
         */
        function showMessage(message, type = 'success') {
            const typeClasses = {
                'success': 'bg-green-100 border-l-4 border-green-500 text-green-700',
                'error': 'bg-red-100 border-l-4 border-red-500 text-red-700',
                'info': 'bg-blue-100 border-l-4 border-blue-500 text-blue-700'
            };

            messageBox.className = `p-4 rounded-md shadow-lg ${typeClasses[type]} hidden`;
            messageBox.innerHTML = `<p class="font-bold">${type.toUpperCase()}</p><p>${message}</p>`;
            
            messageBox.classList.remove('hidden');
            messageBox.classList.add('show');

            setTimeout(() => {
                messageBox.classList.remove('show');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, 5000);
        }

        /**
         * So sánh hai mảng để kiểm tra sự bằng nhau (set equivalence). 
         * Yêu cầu cả hai mảng phải được sắp xếp trước khi so sánh.
         */
        function arraysEqual(arr1, arr2) {
            if (!Array.isArray(arr1) || !Array.isArray(arr2)) return false;
            if (arr1.length !== arr2.length) return false;
            
            for (let i = 0; i < arr1.length; i++) {
                if (arr1[i] !== arr2[i]) return false;
            }
            return true;
        }

        /**
         * Chuyển đổi file CSV/Excel thành mảng dữ liệu câu hỏi chuẩn hóa (Hỗ trợ MCQ và 10 đáp án)
         */
        async function fileToQuizData(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        
                        // Chuyển đổi sang JSON
                        const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        // Chuẩn hóa dữ liệu
                        const questions = [];
                        // Bắt đầu từ hàng thứ 2 (chỉ mục 1) vì hàng đầu tiên là tiêu đề
                        for (let i = 1; i < json.length; i++) {
                            const row = json[i];
                            
                            // Kiểm tra xem Câu hỏi có nội dung hay không (Cột 0)
                            const questionText = row[0] ? row[0].toString().trim() : '';
                            if (!questionText) {
                                // Bỏ qua nếu không có nội dung câu hỏi
                                continue;
                            }

                            // Parse cột đáp án đúng (cột 1) thành mảng số nguyên
                            let correctIndices = [];
                            if (row[1]) {
                                const rawAns = row[1].toString().trim();
                                if (rawAns.includes(',')) {
                                    // Xử lý bằng dấu phẩy 
                                    correctIndices = rawAns.split(',')
                                        .map(s => parseInt(s.trim(), 10));
                                } else {
                                    // Xử lý bằng từng ký tự liền nhau (vd: "1234")
                                    correctIndices = Array.from(rawAns)
                                        .map(c => parseInt(c.trim(), 10));
                                }

                                // Lọc và chuẩn hóa: chỉ chấp nhận index từ 1 đến 10 (cho A-J)
                                correctIndices = correctIndices.filter(n => !isNaN(n) && n >= 1 && n <= 10);
                            }
                            
                            // Cột 2 là bắt đầu của các đáp án (A)
                            let choices = [];
                            // Lấy tối đa 10 phương án lựa chọn (cột 2 đến cột 11)
                            for (let j = 2; j <= 11; j++) {
                                const choiceText = row[j] ? row[j].toString().trim() : '';
                                // Lỗi #2: Chỉ thêm đáp án nếu nó có nội dung
                                if (choiceText) { 
                                    choices.push(choiceText);
                                }
                            }
                            
                            // Kiểm tra điều kiện tối thiểu: Phải có câu hỏi, phải có đáp án đúng được xác định, và phải có ít nhất 2 phương án
                            if (questionText && correctIndices.length > 0 && choices.length >= 2) {
                                const question = {
                                    id: i, // ID duy nhất
                                    question: questionText,
                                    correctAnswerIndices: correctIndices.sort((a, b) => a - b), // Array of sorted indices
                                    choices: choices
                                };
                                questions.push(question);
                            }
                        }
                        resolve(questions);
                    } catch (error) {
                        reject(new Error(`Lỗi xử lý file: ${file.name}. Vui lòng kiểm tra định dạng và cấu trúc cột. Lỗi: ${error.message}`));
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // --- LOCAL STORAGE FUNCTIONS (MỚI) ---

        /**
         * Lưu dữ liệu đề thi vào localStorage
         */
        function saveQuizData() {
            try {
                const dataToSave = JSON.stringify(quizData);
                localStorage.setItem(QUIZ_DATA_STORAGE_KEY, dataToSave);
            } catch (error) {
                console.error("Lỗi khi lưu dữ liệu vào localStorage:", error);
                showMessage("Không thể lưu đề thi (dữ liệu quá lớn hoặc lỗi trình duyệt).", 'error');
            }
        }

        /**
         * Tải dữ liệu đề thi từ localStorage
         */
        function loadQuizData() {
            try {
                const storedData = localStorage.getItem(QUIZ_DATA_STORAGE_KEY);
                if (storedData) {
                    const loadedData = JSON.parse(storedData);
                    if (Array.isArray(loadedData) && loadedData.length > 0) {
                        quizData = loadedData;
                        userAnswers = {}; // Reset đáp án người dùng
                        revealedAnswers = {};
                        isPracticeMode = false;
                        showMessage(`Tự động tải thành công ${quizData.length} câu hỏi từ lần trước.`, 'info');
                        return true;
                    }
                }
            } catch (error) {
                console.error("Lỗi khi tải dữ liệu từ localStorage:", error);
                // Xóa dữ liệu lỗi để tránh lỗi lặp
                localStorage.removeItem(QUIZ_DATA_STORAGE_KEY); 
                showMessage("Lỗi khi tải đề thi đã lưu. Vui lòng tải file mới.", 'error');
            }
            return false;
        }

        /**
         * Xóa dữ liệu đề thi đã lưu khỏi localStorage
         */
        function clearQuizData() {
            localStorage.removeItem(QUIZ_DATA_STORAGE_KEY);
        }

        // --- RENDERING VIEWS ---

        /**
         * Thiết lập trạng thái hiển thị
         */
        function setViewState(state) {
            mainContent.innerHTML = '';
            
            switch (state) {
                case STATE.UPLOAD:
                    renderUploadView();
                    break;
                case STATE.QUIZ:
                    renderQuizView();
                    // Khi vào chế độ Quiz, cần khởi tạo lại việc lọc/phân trang
                    filteredQuizData = [...quizData]; 
                    currentPage = 1;
                    renderQuiz();
                    break;
                case STATE.RESULT:
                    renderResultsView();
                    break;
            }
        }

        /**
         * Render giao diện tải file
         */
        function renderUploadView() {
            mainContent.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-2xl text-center border border-gray-100">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Tải File Đề Thi (Excel/CSV)</h2>
                    <p class="text-gray-600 mb-6">Chọn file đề thi trắc nghiệm của bạn để bắt đầu. 
                        <span class="font-semibold text-indigo-600">Lưu ý:</span> Ứng dụng hỗ trợ tối đa 10 đáp án (A-J). Cột đáp án đúng có thể chứa nhiều số liền nhau (ví dụ: 1234) hoặc phân tách bằng dấu phẩy (ví dụ: 1,3).
                    </p>
                    <input type="file" id="file-input" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" multiple
                        class="block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-50 file:text-blue-700
                        hover:file:bg-blue-100"
                    />
                    <p id="file-count" class="mt-4 text-sm text-gray-500"></p>
                    <p class="text-xs text-gray-400 mt-2">Đề thi sau khi tải thành công sẽ được lưu trữ tự động trên trình duyệt của bạn.</p>
                </div>
            `;
            fileInput = document.getElementById('file-input');
            // Gắn sự kiện tải file
            fileInput.addEventListener('change', handleFileUpload);
        }

        /**
         * Render giao diện làm bài thi
         */
        function renderQuizView() {
            mainContent.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl border border-gray-100 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Làm Bài Thi (Tổng: ${quizData.length} câu)</h2>
                    <div class="mb-4 flex flex-col sm:flex-row gap-4 items-center">
                        <input type="text" id="search-input" placeholder="Tìm kiếm câu hỏi hoặc đáp án..."
                            class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 w-full sm:w-auto"
                        />
                        <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                             <button id="practice-mode-btn"
                                class="px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 transition duration-150 shadow-md flex-grow">
                                Hiện Đáp Án (Ôn tập)
                            </button>
                            <button id="submit-quiz"
                                class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md flex-grow">
                                Nộp Bài & Chấm Điểm
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Vùng chứa các câu hỏi đã được phân trang -->
                <div id="quiz-container" class="space-y-6 mb-6">
                    <!-- Questions will be rendered here -->
                </div>

                <!-- Vùng chứa thanh phân trang -->
                <div id="pagination-container" class="flex justify-center items-center space-x-2 my-8">
                    <!-- Pagination buttons will be rendered here -->
                </div>
            `;
            
            // Cập nhật DOM references và gắn sự kiện
            submitButton = document.getElementById('submit-quiz');
            searchInput = document.getElementById('search-input');
            quizContainer = document.getElementById('quiz-container');
            paginationContainer = document.getElementById('pagination-container');
            practiceModeButton = document.getElementById('practice-mode-btn');

            submitButton.addEventListener('click', handleSubmitQuiz);
            practiceModeButton.addEventListener('click', togglePracticeMode); // Gắn sự kiện cho nút mới
            
            // Gắn sự kiện tìm kiếm với Debounce để tối ưu hiệu suất
            if (searchInput) {
                const debouncedFilter = debounce(filterQuestions, 300);
                searchInput.addEventListener('input', debouncedFilter);
            }
        }
        
        /**
         * Render các nút phân trang
         */
        function renderPaginationControls(totalPages, activePage) {
            paginationContainer.innerHTML = '';
            if (totalPages <= 1) return;

            const createButton = (text, page, disabled = false) => {
                const button = document.createElement('button');
                button.textContent = text;
                button.className = `px-3 py-1 rounded-lg font-medium transition duration-150`;
                button.disabled = disabled;

                if (page === activePage) {
                    button.classList.add('bg-blue-600', 'text-white', 'shadow-md');
                } else if (!disabled) {
                    button.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-blue-100');
                    button.onclick = () => {
                        currentPage = page;
                        renderQuiz();
                        // Cuộn lên đầu trang sau khi chuyển trang
                        window.scrollTo({ top: 0, behavior: 'smooth' }); 
                    };
                } else {
                    button.classList.add('text-gray-400', 'bg-gray-100', 'cursor-not-allowed');
                }
                return button;
            };

            // Nút Previous
            paginationContainer.appendChild(createButton('<< Trước', activePage - 1, activePage === 1));

            // Hiển thị tối đa 5 nút trang (hoặc ít hơn)
            let startPage = Math.max(1, activePage - 2);
            let endPage = Math.min(totalPages, activePage + 2);

            if (activePage <= 3) {
                endPage = Math.min(totalPages, 5);
                startPage = 1;
            }
            if (activePage > totalPages - 2) {
                startPage = Math.max(1, totalPages - 4);
                endPage = totalPages;
            }

            if (startPage > 1) {
                paginationContainer.appendChild(createButton('1', 1));
                if (startPage > 2) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    dots.className = 'px-1 text-gray-500';
                    paginationContainer.appendChild(dots);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationContainer.appendChild(createButton(i.toString(), i));
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    dots.className = 'px-1 text-gray-500';
                    paginationContainer.appendChild(dots);
                }
                paginationContainer.appendChild(createButton(totalPages.toString(), totalPages));
            }

            // Nút Next
            paginationContainer.appendChild(createButton('Sau >>', activePage + 1, activePage === totalPages));
        }

        /**
         * Render các câu hỏi trên trang hiện tại
         */
        function renderQuiz() {
            if (!quizContainer) return;
            
            const totalQuestions = filteredQuizData.length;
            const totalPages = Math.ceil(totalQuestions / questionsPerPage);

            const startIndex = (currentPage - 1) * questionsPerPage;
            const endIndex = Math.min(startIndex + questionsPerPage, totalQuestions);
            
            const paginatedQuestions = filteredQuizData.slice(startIndex, endIndex);

            // Kiểm tra nếu không có câu hỏi nào khớp với tìm kiếm/phân trang
            if (paginatedQuestions.length === 0 && filteredQuizData.length > 0) {
                 // Nếu đang ở trang lớn hơn 1 nhưng không có câu hỏi (do lọc/xóa) thì quay về trang 1
                 currentPage = 1;
                 renderQuiz(); 
                 return;
            } else if (filteredQuizData.length === 0) {
                 quizContainer.innerHTML = `<div class="text-center py-12 text-gray-500 text-lg font-medium">Không tìm thấy câu hỏi nào.</div>`;
                 renderPaginationControls(0, 0);
                 return;
            }

            let html = '';
            
            // Dùng for...of để dễ đọc và hiệu suất chấp nhận được
            for (const [i, q] of paginatedQuestions.entries()) {
                // Chỉ mục toàn cục (để lấy đáp án từ userAnswers và revealedAnswers)
                const globalIndex = quizData.indexOf(q); 
                // Sử dụng cờ revealedAnswers (sau khi nộp bài) HOẶC cờ isPracticeMode (chế độ ôn tập)
                const isRevealed = revealedAnswers[globalIndex] || isPracticeMode; 
                // userAnswers[globalIndex] giờ là MẢNG các lựa chọn
                const selectedIndices = userAnswers[globalIndex]; 
                const questionNumber = globalIndex + 1;

                html += quizHTML(questionNumber, q, globalIndex, selectedIndices, isRevealed);
            }

            // Cập nhật DOM chỉ một lần (quan trọng cho hiệu suất)
            quizContainer.innerHTML = html; 

            // Gắn lại sự kiện chọn đáp án sau khi render
            document.querySelectorAll('.choice-btn').forEach(button => {
                // Chỉ gắn sự kiện nếu KHÔNG ở chế độ ôn tập
                if (!isPracticeMode) { 
                    button.addEventListener('click', handleAnswerSelection);
                }
            });
            
            // Cập nhật trạng thái hiển thị của nút
            updatePracticeModeButton();

            // Render lại thanh phân trang
            renderPaginationControls(totalPages, currentPage);
        }

        /**
         * Cập nhật văn bản và màu sắc của nút Chế độ Ôn tập
         */
        function updatePracticeModeButton() {
            if (practiceModeButton) {
                if (isPracticeMode) {
                    practiceModeButton.textContent = 'Ẩn Đáp Án (Tiếp tục làm bài)';
                    practiceModeButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                    practiceModeButton.classList.add('bg-gray-500', 'hover:bg-gray-600');
                    // Thêm class lên container để vô hiệu hóa input
                    if (quizContainer) quizContainer.classList.add('quiz-revealed');
                } else {
                    practiceModeButton.textContent = 'Hiện Đáp Án (Chế độ Ôn tập)';
                    practiceModeButton.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                    practiceModeButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                    // Xóa class để cho phép input
                    if (quizContainer) quizContainer.classList.remove('quiz-revealed');
                }
            }
        }

        /**
         * Chuyển đổi giữa chế độ làm bài và chế độ ôn tập (hiện đáp án)
         */
        function togglePracticeMode() {
            isPracticeMode = !isPracticeMode;
            renderQuiz(); // Render lại các câu hỏi để áp dụng style mới
            showMessage(isPracticeMode ? "Đã chuyển sang chế độ Ôn tập (Đáp án đúng được hiển thị)." : "Đã quay lại chế độ làm bài bình thường.", 'info');
        }

        /**
         * Render giao diện kết quả
         */
        function renderResultsView() {
            // Đảm bảo chế độ ôn tập được tắt khi nộp bài
            isPracticeMode = false;

            const total = quizData.length;
            let correctCount = 0;
            
            // Tính điểm (ĐÃ CẬP NHẬT CHO MCQ)
            for (let i = 0; i < total; i++) {
                const q = quizData[i];
                // Lấy đáp án của người dùng (mảng, có thể là undefined/null)
                const userAns = userAnswers[i] || [];
                
                // Lấy đáp án đúng (mảng)
                const correctAns = q.correctAnswerIndices;

                // So sánh: Đúng nếu mảng lựa chọn của người dùng trùng khớp hoàn toàn với mảng đáp án đúng
                if (arraysEqual(userAns, correctAns)) {
                    correctCount++;
                }
            }

            const score = ((correctCount / total) * 10).toFixed(2);

            mainContent.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-2xl text-center border border-gray-100">
                    <h2 class="text-3xl font-bold mb-4 text-gray-800">KẾT QUẢ BÀI THI</h2>
                    <div class="space-y-4">
                        <p class="text-lg text-gray-700">Tổng số câu hỏi: <span class="font-extrabold text-indigo-600">${total}</span></p>
                        <p class="text-2xl text-gray-700">Số câu trả lời đúng: <span class="font-extrabold text-green-600">${correctCount}</span></p>
                        <p class="text-4xl font-extrabold p-4 rounded-xl bg-blue-50 text-blue-800 shadow-inner">ĐIỂM: ${score}/10</p>
                    </div>

                    <p class="text-gray-600 mt-6">Bạn có thể xem lại đáp án và câu trả lời của mình bên dưới.</p>
                    
                    <button id="restart-quiz"
                        class="mt-8 px-8 py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 shadow-md">
                        Làm Bài Thi Mới
                    </button>
                    
                    <button id="view-answers"
                        class="mt-8 ml-4 px-8 py-3 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition duration-150 shadow-md">
                        Xem lại đáp án
                    </button>
                </div>
                
                <!-- Vùng chứa các câu hỏi và đáp án -->
                <div id="result-quiz-container" class="space-y-6 mt-8">
                    <!-- Questions will be rendered here for review -->
                </div>
            `;
            
            // Cập nhật DOM references và gắn sự kiện
            restartButton = document.getElementById('restart-quiz');
            const viewAnswersButton = document.getElementById('view-answers');
            quizContainer = document.getElementById('result-quiz-container');

            restartButton.addEventListener('click', handleRestartQuiz);
            viewAnswersButton.addEventListener('click', handleReviewAnswers);
            
            // Mặc định hiển thị lại các câu hỏi đã làm
            handleReviewAnswers();
        }

        // --- CORE LOGIC ---

        /**
         * Tạo HTML cho một câu hỏi (card) - ĐÃ CẬP NHẬT ĐỂ HỖ TRỢ 10 ĐÁP ÁN
         */
        function quizHTML(questionNumber, q, globalIndex, selectedIndices, isRevealed) {
            const correctAnswerIndices = q.correctAnswerIndices || [];
            
            let choicesHtml = q.choices.map((choice, choiceIndex) => {
                const choiceValue = choiceIndex + 1; // Giá trị đáp án (1-based)
                
                // Mặc định
                let classes = 'choice-btn p-3 rounded-lg border-2 text-left transition duration-100 ease-in-out cursor-pointer hover:bg-gray-100 bg-white border-gray-200 shadow-sm';
                
                // Kiểm tra xem đáp án có nằm trong mảng các lựa chọn của người dùng không
                const isSelectedByUser = Array.isArray(selectedIndices) && selectedIndices.includes(choiceValue);
                // Kiểm tra xem đáp án có nằm trong mảng các đáp án đúng không
                const isCorrectAnswer = correctAnswerIndices.includes(choiceValue);
                
                if (isRevealed) {
                    // Chế độ xem đáp án (hoặc ôn tập)
                    
                    // 1. Highlight đáp án đúng
                    if (isCorrectAnswer) {
                        classes = 'correct-choice p-3 rounded-lg border-2 text-left shadow-md pointer-events-none';
                    } 
                    // 2. Highlight đáp án SAI mà người dùng đã chọn (chỉ áp dụng khi nộp bài)
                    else if (isSelectedByUser && revealedAnswers[globalIndex]) {
                        classes = 'bg-red-100 border-red-500 font-medium p-3 rounded-lg border-2 text-left shadow-sm pointer-events-none';
                    } 
                    // 3. Đáp án không đúng, không chọn
                    else {
                        classes = 'bg-white border-gray-200 shadow-sm p-3 rounded-lg border-2 text-left pointer-events-none';
                    }

                } else {
                    // Chế độ làm bài bình thường
                    if (isSelectedByUser) {
                        classes += ' selected'; // blue background
                    }
                }

                // Chỉ mục hiển thị (A, B, C, ...)
                // Sử dụng mã ASCII bắt đầu từ 65 ('A')
                const indicator = String.fromCharCode(65 + choiceIndex); 

                return `
                    <button data-index="${globalIndex}" data-value="${choiceValue}" 
                        class="${classes}">
                        <span class="font-bold mr-2">${indicator}.</span> ${choice}
                    </button>
                `;
            }).join('');

            return `
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <p class="text-lg font-semibold text-gray-800 mb-3">
                        <span class="text-indigo-600 mr-2">Câu ${questionNumber}:</span> ${q.question}
                    </p>
                    <div class="flex flex-col space-y-3">
                        ${choicesHtml}
                    </div>
                </div>
            `;
        }
        
        /**
         * Xử lý lọc câu hỏi (sử dụng Debounce)
         */
        function filterQuestions() {
            if (!searchInput || !quizData || quizData.length === 0) return;
            
            const query = searchInput.value.toLowerCase().trim();

            // Lọc trên toàn bộ dữ liệu gốc (quizData)
            if (!query) {
                filteredQuizData = [...quizData];
            } else {
                filteredQuizData = quizData.filter(q =>
                    q.question.toLowerCase().includes(query) ||
                    q.choices.some(c => c.toLowerCase().includes(query))
                );
            }

            // Thiết lập lại trang về 1 và render lại
            currentPage = 1;
            renderQuiz();
        }

        /**
         * Hiển thị kết quả (chấm điểm)
         */
        function renderResults() {
            // Đánh dấu tất cả câu hỏi đã được làm bài thi là Revealed
            quizData.forEach((q, index) => {
                revealedAnswers[index] = true;
            });
            setViewState(STATE.RESULT);
        }

        /**
         * Xử lý sự kiện chọn đáp án (ĐÃ CẬP NHẬT CHO MCQ)
         */
        function handleAnswerSelection(event) {
            // Nếu đang ở chế độ ôn tập thì không làm gì
            if (isPracticeMode) return; 

            const button = event.currentTarget;
            const globalIndex = parseInt(button.dataset.index, 10);
            const value = parseInt(button.dataset.value, 10);
            
            // Khởi tạo hoặc lấy mảng đáp án đã chọn cho câu hỏi này
            let currentSelections = userAnswers[globalIndex] || [];

            // Kiểm tra xem đáp án này đã được chọn chưa
            const valueIndex = currentSelections.indexOf(value);
            const isSelected = valueIndex > -1;

            if (isSelected) {
                // Nếu đã chọn -> Hủy chọn (Toggle off)
                currentSelections.splice(valueIndex, 1);
                button.classList.remove('selected');
            } else {
                // Nếu chưa chọn -> Chọn (Toggle on)
                currentSelections.push(value);
                button.classList.add('selected');
            }
            
            // Sắp xếp các lựa chọn để đảm bảo tính nhất quán (quan trọng cho chấm điểm)
            currentSelections.sort((a, b) => a - b);

            // Cập nhật lại userAnswers
            if (currentSelections.length > 0) {
                userAnswers[globalIndex] = currentSelections;
            } else {
                // Loại bỏ trường hợp mảng rỗng
                delete userAnswers[globalIndex];
            }
        }

        /**
         * Xử lý danh sách file tải lên
         */
        async function processFiles(files) {
            let combinedQuestions = [];
            const fileCountElement = document.getElementById('file-count');
            fileCountElement.textContent = `Đang xử lý ${files.length} file...`;

            for (const file of files) {
                try {
                    const questionsFromFile = await fileToQuizData(file);
                    combinedQuestions.push(...questionsFromFile);
                    fileCountElement.textContent = `Đã tải ${combinedQuestions.length} câu hỏi từ ${files.length} file.`;
                } catch (error) {
                    showMessage(error.message, 'error');
                }
            }

            if (combinedQuestions.length > 0) {
                quizData = combinedQuestions;
                userAnswers = {};
                revealedAnswers = {};
                isPracticeMode = false; // Reset chế độ ôn tập
                
                // === LƯU DỮ LIỆU VÀO LOCAL STORAGE SAU KHI TẢI THÀNH CÔNG ===
                saveQuizData(); 
                
                showMessage(`Tải thành công ${quizData.length} câu hỏi. Chuyển sang làm bài thi.`, 'success');
                setViewState(STATE.QUIZ);
            } else {
                showMessage("Không tìm thấy câu hỏi hợp lệ trong các file đã tải. Kiểm tra định dạng đáp án (ví dụ: 123 hoặc 1,3) và nội dung câu hỏi/đáp án.", 'error');
                fileCountElement.textContent = '';
            }
        }

        /**
         * Xử lý sự kiện tải file CSV/Excel (Hỗ trợ nhiều file)
         */
        async function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            // Xử lý danh sách file
            processFiles(files);
        }

        /**
         * Xử lý sự kiện nộp bài
         */
        function handleSubmitQuiz() {
            if (quizData.length === 0) {
                showMessage("Vui lòng tải lên file đề thi trước.", 'info');
                return;
            }
            renderResults();
        }

        /**
         * Xử lý sự kiện làm bài thi mới
         */
        function handleRestartQuiz() {
            // === XÓA DỮ LIỆU ĐÃ LƯU KHI BẮT ĐẦU BÀI THI MỚI ===
            clearQuizData(); 
            
            quizData = [];
            userAnswers = {};
            revealedAnswers = {};
            isPracticeMode = false; // Reset chế độ ôn tập
            // Nếu có, reset input file
            if (fileInput) { 
                fileInput.value = ''; 
            }
            setViewState(STATE.UPLOAD);
        }
        
        /**
         * Xử lý sự kiện xem lại đáp án
         */
        function handleReviewAnswers() {
            // Đặt lại dữ liệu lọc/phân trang để hiển thị tất cả câu hỏi đã chấm
            filteredQuizData = [...quizData];
            currentPage = 1;
            // Đảm bảo ở chế độ kết quả, các câu hỏi luôn hiển thị đáp án
            isPracticeMode = false; 
            renderQuiz(); 
            // Cập nhật tiêu đề
            const titleElement = document.querySelector('.bg-white.p-8.rounded-xl').nextElementSibling;
             if (titleElement) {
                titleElement.textContent = 'Kết quả & Đáp án chi tiết';
             }
        }


        // --- INITIALIZATION ---
        function init() {
            // === TẢI DỮ LIỆU ĐÃ LƯU VÀO TRẠNG THÁI (MỚI) ===
            const hasLoadedData = loadQuizData();

            if (hasLoadedData) {
                // Nếu có dữ liệu đã lưu, chuyển thẳng đến giao diện làm bài
                setViewState(STATE.QUIZ); 
            } else {
                // Ngược lại, hiển thị giao diện tải file
                setViewState(STATE.UPLOAD); 
            }
        }

        window.onload = init;

    </script>
</body>
</html>
